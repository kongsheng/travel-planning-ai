# 🚀 腾讯云轻量服务器部署教程（超详细）

## 📋 准备工作

### 1. 购买服务器（¥50/年）

#### 步骤：
1. 访问：https://cloud.tencent.com/act/pro/lighthousespecial
2. 选择配置：
   ```
   套餐：1核2G 50GB 4M带宽
   地域：上海/广州/北京（选离你近的）
   镜像：Ubuntu 20.04 LTS
   时长：1年
   价格：¥50（新用户）
   ```
3. 点击"立即购买"，完成支付

#### 购买后记录信息：
```
公网IP：xxx.xxx.xxx.xxx（在控制台查看）
用户名：ubuntu（默认）
密码：需要在控制台重置
```

### 2. 重置密码（首次使用必须）

1. 进入腾讯云控制台：https://console.cloud.tencent.com/lighthouse/instance
2. 找到你的服务器
3. 点击"重置密码"
4. 设置新密码（建议：大小写字母+数字+符号，例如：Aa123456!）
5. 重启服务器

### 3. 配置防火墙规则

在腾讯云控制台：
1. 点击服务器 → "防火墙"
2. 添加规则：
   ```
   应用类型    协议端口    来源
   HTTP(80)    TCP:80      0.0.0.0/0
   HTTPS(443)  TCP:443     0.0.0.0/0
   SSH(22)     TCP:22      0.0.0.0/0
   ```
3. 保存

---

## 🔐 第一步：连接到服务器

### Windows 用户：

#### 方法1：使用 PowerShell（推荐）
```powershell
# 打开 PowerShell，输入
ssh ubuntu@你的服务器IP

# 例如
ssh ubuntu@123.456.789.012

# 输入密码（密码不显示，正常输入后按 Enter）
```

#### 方法2：使用腾讯云网页控制台
1. 登录腾讯云控制台
2. 点击服务器 → "登录"
3. 选择"使用 VNC 登录"

### Mac/Linux 用户：
```bash
ssh ubuntu@你的服务器IP
```

---

## 📦 第二步：推送代码到 GitHub（本地操作）

### 1. 初始化 Git（如果还没有）
```bash
# 在项目根目录执行
cd i:\shopProject\comyui\travel-planning-ai

# 初始化 Git
git init

# 添加 .gitignore
echo "node_modules/" > .gitignore
echo "backend/node_modules/" >> .gitignore
echo "backend/.env" >> .gitignore
echo ".env.local" >> .gitignore
echo "dist/" >> .gitignore

# 添加所有文件
git add .

# 提交
git commit -m "Initial commit"
```

### 2. 创建 GitHub 仓库
1. 访问 https://github.com/new
2. 仓库名：`travel-planning-ai`
3. 选择 `Public`（公开）或 `Private`（私有）
4. 点击 "Create repository"

### 3. 推送代码
```bash
# 添加远程仓库（替换成你的用户名）
git remote add origin https://github.com/你的用户名/travel-planning-ai.git

# 推送代码
git branch -M main
git push -u origin main
```

---

## 🚀 第三步：服务器端部署

### 方法1：使用自动脚本（推荐，最简单）

#### 1. 连接服务器
```bash
ssh ubuntu@你的服务器IP
```

#### 2. 下载并运行部署脚本
```bash
# 下载脚本
wget https://raw.githubusercontent.com/你的用户名/travel-planning-ai/main/deploy-to-server.sh

# 赋予执行权限
chmod +x deploy-to-server.sh

# 但是需要先修改脚本中的 GitHub 地址！
nano deploy-to-server.sh

# 找到这一行：
# git clone https://github.com/你的用户名/travel-planning-ai.git
# 改成你的实际 GitHub 地址

# 保存（Ctrl+O，Enter）并退出（Ctrl+X）

# 运行脚本
bash deploy-to-server.sh
```

脚本会自动：
- ✅ 安装 Node.js、PM2、Nginx
- ✅ 克隆代码
- ✅ 安装依赖
- ✅ 构建前端
- ✅ 启动服务

#### 3. 配置 API Key
```bash
# 编辑环境变量文件
nano ~/travel-planning-ai/backend/.env

# 修改这一行：
ZHIPU_API_KEY=你的智谱API密钥

# 保存（Ctrl+O，Enter）并退出（Ctrl+X）

# 重启后端服务
pm2 restart travel-backend
```

---

### 方法2：手动部署（适合学习）

#### 1. 更新系统
```bash
sudo apt update && sudo apt upgrade -y
```

#### 2. 安装 Node.js 18
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node -v  # 应该显示 v18.x.x
npm -v
```

#### 3. 安装 PM2
```bash
sudo npm install -g pm2
```

#### 4. 安装 Nginx
```bash
sudo apt install -y nginx
```

#### 5. 克隆项目
```bash
cd ~
git clone https://github.com/你的用户名/travel-planning-ai.git
cd travel-planning-ai
```

#### 6. 配置后端
```bash
cd backend

# 创建环境变量文件
cat > .env << EOF
ZHIPU_API_KEY=你的智谱API密钥
PORT=3001
NODE_ENV=production
EOF

# 安装依赖
npm install --production

# 启动服务
pm2 start server.js --name travel-backend
pm2 save
pm2 startup
```

#### 7. 构建前端
```bash
cd ..

# 创建生产环境配置
echo "VITE_BACKEND_URL=http://localhost:3001" > .env.production

# 安装依赖并构建
npm install
npm run build

# 部署到 Nginx
sudo rm -rf /var/www/html/*
sudo cp -r dist/* /var/www/html/
```

#### 8. 配置 Nginx
```bash
sudo nano /etc/nginx/sites-available/default
```

替换为以下内容：
```nginx
server {
    listen 80;
    server_name _;

    # 前端静态文件
    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }

    # 启用压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
```

保存并退出（Ctrl+O，Enter，Ctrl+X）

#### 9. 重启 Nginx
```bash
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
```

#### 10. 配置防火墙
```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable
```

---

## ✅ 第四步：测试访问

### 1. 打开浏览器
```
http://你的服务器IP
```

### 2. 测试生成行程
- 目的地：北京
- 日期：2025-10-28
- 天数：3
- 类型：家庭游
- 点击"开始规划"

### 3. 检查服务状态
```bash
# 查看后端运行状态
pm2 status

# 查看后端日志
pm2 logs travel-backend

# 查看 Nginx 状态
sudo systemctl status nginx
```

---

## 🔄 后续更新部署

当你修改代码后，需要重新部署：

### 1. 本地推送代码
```bash
# 在本地项目目录
git add .
git commit -m "更新功能"
git push
```

### 2. 服务器端更新
```bash
# SSH 登录服务器
ssh ubuntu@你的服务器IP

# 拉取最新代码
cd ~/travel-planning-ai
git pull

# 更新后端
cd backend
npm install
pm2 restart travel-backend

# 更新前端
cd ..
npm install
npm run build
sudo cp -r dist/* /var/www/html/
```

### 或者使用快捷脚本：
```bash
# 创建更新脚本
cat > ~/update.sh << 'EOF'
#!/bin/bash
cd ~/travel-planning-ai
git pull
cd backend
npm install
pm2 restart travel-backend
cd ..
npm install
npm run build
sudo cp -r dist/* /var/www/html/
echo "✅ 更新完成！"
EOF

chmod +x ~/update.sh

# 以后更新只需运行：
~/update.sh
```

---

## 🌐 （可选）配置域名和 HTTPS

### 1. 购买域名
- 阿里云：https://wanwang.aliyun.com/
- 腾讯云：https://dnspod.cloud.tencent.com/
- 价格：¥30-50/年（.com 域名）

### 2. 域名解析
在域名控制台添加 A 记录：
```
主机记录：@（或 www）
记录类型：A
记录值：你的服务器IP
TTL：600
```

### 3. 安装 SSL 证书（免费）
```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 自动配置 HTTPS
sudo certbot --nginx -d 你的域名.com

# 按提示输入邮箱，同意协议
```

自动续期（证书90天有效）：
```bash
# 测试续期
sudo certbot renew --dry-run

# 添加定时任务（每天检查）
sudo crontab -e

# 添加这一行
0 3 * * * certbot renew --quiet
```

---

## 📊 监控和维护

### 1. 查看服务器资源
```bash
# 内存使用
free -h

# 磁盘使用
df -h

# CPU 和进程
htop  # 需要先安装：sudo apt install htop
```

### 2. 查看日志
```bash
# 后端日志
pm2 logs travel-backend

# Nginx 访问日志
sudo tail -f /var/log/nginx/access.log

# Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

### 3. 设置日志轮转（防止日志文件过大）
```bash
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

---

## ⚠️ 常见问题

### Q1: 无法访问网站？
```bash
# 检查 Nginx
sudo systemctl status nginx

# 检查后端
pm2 status

# 检查防火墙
sudo ufw status

# 检查腾讯云控制台的防火墙规则
```

### Q2: 502 Bad Gateway？
```bash
# 后端可能没有启动
pm2 restart travel-backend

# 查看后端日志
pm2 logs travel-backend
```

### Q3: API 调用失败？
```bash
# 检查环境变量
cat ~/travel-planning-ai/backend/.env

# 确认 API Key 正确
# 检查智谱 API 余额
```

### Q4: 内存不足？
```bash
# 添加 Swap 交换空间（临时扩容）
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久生效
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### Q5: 服务器重启后服务没有自动启动？
```bash
# 设置 PM2 开机自启
pm2 startup
pm2 save

# 设置 Nginx 开机自启
sudo systemctl enable nginx
```

---

## 💰 成本总结

```
服务器：¥50/年（新用户）或 ¥108/年（续费）
域名：¥30-50/年（可选）
SSL证书：免费（Let's Encrypt）

总计：¥50-158/年
平均每月：¥4-13

比点一杯奶茶还便宜！
```

---

## 🎯 下一步

部署成功后，你可以：
1. ✅ 开始推广（小红书/抖音/知乎）
2. ✅ 收集用户反馈
3. ✅ 添加付费功能
4. ✅ 接入广告和返佣

**祝你部署顺利，早日实现盈利！🎉**
