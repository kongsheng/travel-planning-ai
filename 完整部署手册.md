   # 🚀 服务器部署完整操作手册

## 服务器信息
```
公网IP: 49.235.101.226
用户名: ubuntu
密码: [你设置的密码]
系统: Ubuntu 20.04 LTS
```

---

## 📦 第一步：推送代码到 GitHub（本地操作）

### 1. 初始化 Git 并提交代码

在本地项目目录（PowerShell）执行：

```powershell
# 已经执行过 git init，跳过

# 创建 .gitignore 文件
@"
node_modules/
backend/node_modules/
backend/.env
.env.local
.env.production
dist/
.DS_Store
*.log
"@ | Out-File -FilePath .gitignore -Encoding utf8

# 添加所有文件
git add .

# 提交
git commit -m "Initial commit - Travel Planning AI"
```

### 2. 创建 GitHub 仓库

1. 访问：https://github.com/new
2. 仓库名：`travel-planning-ai`
3. 设置为 **Public**（公开）
4. **不要**勾选 "Add a README file"
5. 点击 **"Create repository"**

### 3. 推送代码到 GitHub

GitHub 会显示命令，或者执行以下命令：

```powershell
# 添加远程仓库（替换成你的 GitHub 用户名）
git remote add origin https://github.com/你的用户名/travel-planning-ai.git

# 推送代码
git branch -M main
git push -u origin main
```

如果提示输入用户名密码：
- 用户名：你的 GitHub 用户名
- 密码：使用 Personal Access Token（不是登录密码）
  - 获取 Token：https://github.com/settings/tokens
  - 点击 "Generate new token (classic)"
  - 勾选 "repo" 权限
  - 生成后复制 Token 作为密码使用

---

## 🔐 第二步：连接到服务器

### 1. 使用 PowerShell 连接

```powershell
# 连接命令
ssh ubuntu@49.235.101.226

# 首次连接会提示是否信任，输入 yes
# 然后输入你设置的密码
```

### 2. 如果连接失败

检查：
- 防火墙是否开放 22 端口（SSH）
- 密码是否正确
- 服务器是否正在运行

---

## 🛠️ 第三步：服务器端部署（自动脚本）

### 方法A：一键自动部署（推荐）

连接到服务器后，执行以下命令：

```bash
# 1. 下载部署脚本
wget -O deploy.sh https://raw.githubusercontent.com/kongsheng/travel-planning-ai/main/deploy-to-server.sh

# 如果 wget 下载失败，手动创建脚本
nano deploy.sh
# 然后把下面的脚本内容复制进去，按 Ctrl+O 保存，Ctrl+X 退出

# 2. 赋予执行权限
chmod +x deploy.sh

# 3. 运行部署脚本
bash deploy.sh
```

### 方法B：手动部署（详细步骤）

如果自动脚本出问题，按以下步骤手动部署：

#### 步骤1：更新系统
```bash
sudo apt update && sudo apt upgrade -y
```

#### 步骤2：安装 Node.js 18
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
node -v  # 验证安装
npm -v
```

#### 步骤3：安装 PM2
```bash
sudo npm install -g pm2
```

#### 步骤4：安装 Nginx
```bash
sudo apt install -y nginx
```

#### 步骤5：克隆项目
```bash
cd ~
git clone https://github.com/你的用户名/travel-planning-ai.git
cd travel-planning-ai
```

#### 步骤6：配置后端
```bash
cd backend

# 创建环境变量文件
cat > .env << 'EOF'
ZHIPU_API_KEY=你的智谱API密钥
ZHIPU_API_URL=https://open.bigmodel.cn/api/paas/v4/chat/completions
PEXELS_API_KEY=
PORT=3001
NODE_ENV=production
EOF

# 编辑填入真实的 API Key
nano .env
# 修改 ZHIPU_API_KEY 那一行
# Ctrl+O 保存，Ctrl+X 退出

# 安装依赖
npm install --production

# 启动后端
pm2 start server.js --name travel-backend
pm2 save
pm2 startup
```

#### 步骤7：构建前端
```bash
cd ~/travel-planning-ai

# 创建生产环境配置
echo "VITE_BACKEND_URL=http://localhost:3001" > .env.production

# 安装依赖
npm install

# 构建
npm run build

# 部署到 Nginx
sudo rm -rf /var/www/html/*
sudo cp -r dist/* /var/www/html/
```

#### 步骤8：配置 Nginx
```bash
sudo nano /etc/nginx/sites-available/default
```

删除所有内容，替换为：
```nginx
server {
    listen 80;
    server_name _;

    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
```

保存并退出（Ctrl+O，Enter，Ctrl+X）

#### 步骤9：重启 Nginx
```bash
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
```

#### 步骤10：配置防火墙
```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable
```

---

## ✅ 第四步：测试访问

### 1. 打开浏览器
访问：http://49.235.101.226

### 2. 测试生成行程
- 目的地：北京
- 日期：2025-10-28
- 天数：3
- 类型：家庭游
- 点击"开始规划"

### 3. 检查服务状态
```bash
# 查看后端状态
pm2 status

# 查看后端日志
pm2 logs travel-backend

# 查看 Nginx 状态
sudo systemctl status nginx
```

---

## 🔄 后续更新部署

### 本地修改代码后：

```powershell
# 1. 提交代码
git add .
git commit -m "更新功能"
git push
```

### 服务器端更新：

```bash
# 1. SSH 登录服务器
ssh ubuntu@49.235.101.226

# 2. 执行更新
cd ~/travel-planning-ai
git pull

# 3. 更新后端
cd backend
npm install
pm2 restart travel-backend

# 4. 更新前端
cd ..
npm install
npm run build
sudo cp -r dist/* /var/www/html/

echo "✅ 更新完成！"
```

### 或者创建快捷更新脚本：

```bash
# 创建更新脚本
cat > ~/update.sh << 'EOF'
#!/bin/bash
cd ~/travel-planning-ai
git pull
cd backend
npm install
pm2 restart travel-backend
cd ..
npm install
npm run build
sudo cp -r dist/* /var/www/html/
echo "✅ 更新完成！"
EOF

chmod +x ~/update.sh

# 以后更新只需执行：
~/update.sh
```

---

## 📊 常用命令

### 查看服务状态
```bash
# 后端服务
pm2 status
pm2 logs travel-backend
pm2 restart travel-backend
pm2 stop travel-backend

# Nginx
sudo systemctl status nginx
sudo systemctl restart nginx
sudo systemctl stop nginx
sudo systemctl start nginx

# 系统资源
free -h        # 内存
df -h          # 磁盘
htop           # CPU和进程（需安装：sudo apt install htop）
```

### 查看日志
```bash
# 后端日志
pm2 logs travel-backend

# Nginx 访问日志
sudo tail -f /var/log/nginx/access.log

# Nginx 错误日志
sudo tail -f /var/log/nginx/error.log

# 系统日志
sudo journalctl -xe
```

### 文件操作
```bash
# 查看文件
cat 文件名
less 文件名

# 编辑文件
nano 文件名

# 查看目录
ls -la

# 进入目录
cd 目录名

# 返回上级目录
cd ..

# 返回主目录
cd ~
```

---

## 🆘 常见问题排查

### 1. 无法访问网站
```bash
# 检查 Nginx
sudo systemctl status nginx
sudo nginx -t

# 检查后端
pm2 status
pm2 logs travel-backend

# 检查防火墙
sudo ufw status

# 检查端口占用
sudo netstat -tlnp | grep 80
sudo netstat -tlnp | grep 3001
```

### 2. 后端 API 调用失败
```bash
# 查看后端日志
pm2 logs travel-backend

# 检查环境变量
cat ~/travel-planning-ai/backend/.env

# 重启后端
pm2 restart travel-backend
```

### 3. 502 Bad Gateway
```bash
# 后端没有启动
pm2 start ~/travel-planning-ai/backend/server.js --name travel-backend

# 检查端口
curl http://localhost:3001/api/health
```

### 4. 内存不足
```bash
# 添加 Swap
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

---

## 🎯 下一步优化

### 1. 绑定域名（可选）

如果你有域名，可以绑定：

```bash
# 编辑 Nginx 配置
sudo nano /etc/nginx/sites-available/default

# 修改 server_name
server_name 你的域名.com www.你的域名.com;

# 重启 Nginx
sudo systemctl restart nginx
```

### 2. 配置 HTTPS（推荐）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 自动配置 HTTPS
sudo certbot --nginx -d 你的域名.com

# 自动续期
sudo crontab -e
# 添加：0 3 * * * certbot renew --quiet
```

### 3. 设置监控

使用 UptimeRobot 免费监控：
1. 注册：https://uptimerobot.com/
2. 添加监控：http://49.235.101.226
3. 设置通知邮箱

---

## 📞 需要帮助？

遇到问题时：
1. 查看错误日志（`pm2 logs` 或 `/var/log/nginx/error.log`）
2. 检查服务状态（`pm2 status` 和 `systemctl status nginx`）
3. 把错误信息告诉我，我会帮你解决

**祝你部署顺利！🎉**
