const express = require('express');
const cors = require('cors');
const axios = require('axios');
const http = require('http');
const https = require('https');
const PDFService = require('./pdfService');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

// åˆ›å»ºæŒä¹…åŒ–çš„ HTTP Agentï¼ˆå¤ç”¨è¿æ¥ï¼Œé¿å…é¦–æ¬¡è¯·æ±‚æ…¢ï¼‰
const httpsAgent = new https.Agent({
  keepAlive: true,
  keepAliveMsecs: 30000, // ä¿æŒè¿æ¥30ç§’
  maxSockets: 50,
  maxFreeSockets: 10,
  timeout: 60000
});

// ä¸­é—´ä»¶
app.use(cors());
app.use(express.json());

// ç™¾åº¦/Pexels å›¾ç‰‡æœç´¢æœåŠ¡ï¼ˆæ— éœ€API Keyæˆ–ä½¿ç”¨å…è´¹Pexels APIï¼‰
class ImageSearchService {
  constructor() {
    this.pexelsApiKey = process.env.PEXELS_API_KEY;
    this.unsplashAccessKey = process.env.UNSPLASH_ACCESS_KEY;
    this.usePexels = !!this.pexelsApiKey;
    this.useUnsplash = !!this.unsplashAccessKey;
    this.httpsAgent = httpsAgent; // ä½¿ç”¨å…¨å±€ agent
    // é¢„è®¾åŸå¸‚å›¾ç‰‡åº“ï¼ˆé«˜è´¨é‡çœŸå®å›¾ç‰‡ï¼‰
    this.cityImageMap = {
      'åŒ—äº¬': 'https://images.pexels.com/photos/208736/pexels-photo-208736.jpeg?auto=compress&w=800',
      'åŒ—äº¬ åœ°æ ‡': 'https://images.pexels.com/photos/208736/pexels-photo-208736.jpeg?auto=compress&w=800',
      'æ•…å®«': 'https://images.pexels.com/photos/208736/pexels-photo-208736.jpeg?auto=compress&w=800',
      'é•¿åŸ': 'https://images.pexels.com/photos/2893685/pexels-photo-2893685.jpeg?auto=compress&w=800',
      'å¤©å›': 'https://images.pexels.com/photos/1486222/pexels-photo-1486222.jpeg?auto=compress&w=800',
      'ä¸Šæµ·': 'https://images.pexels.com/photos/2412609/pexels-photo-2412609.jpeg?auto=compress&w=800',
      'å¤–æ»©': 'https://images.pexels.com/photos/2412609/pexels-photo-2412609.jpeg?auto=compress&w=800',
      'ä¸œæ–¹æ˜ç ': 'https://images.pexels.com/photos/2412611/pexels-photo-2412611.jpeg?auto=compress&w=800',
      'æ­å·': 'https://images.pexels.com/photos/2096750/pexels-photo-2096750.jpeg?auto=compress&w=800',
      'è¥¿æ¹–': 'https://images.pexels.com/photos/2096750/pexels-photo-2096750.jpeg?auto=compress&w=800',
      'å¹¿å·': 'https://images.pexels.com/photos/2412610/pexels-photo-2412610.jpeg?auto=compress&w=800',
      'æ·±åœ³': 'https://images.pexels.com/photos/2662116/pexels-photo-2662116.jpeg?auto=compress&w=800',
      'æˆéƒ½': 'https://images.pexels.com/photos/2901046/pexels-photo-2901046.jpeg?auto=compress&w=800',
      'è¥¿å®‰': 'https://images.pexels.com/photos/3889855/pexels-photo-3889855.jpeg?auto=compress&w=800',
      'å—äº¬': 'https://images.pexels.com/photos/2850287/pexels-photo-2850287.jpeg?auto=compress&w=800',
      'é‡åº†': 'https://images.pexels.com/photos/2846217/pexels-photo-2846217.jpeg?auto=compress&w=800',
      'å¤©æ´¥': 'https://images.pexels.com/photos/1486222/pexels-photo-1486222.jpeg?auto=compress&w=800',
      'è‹å·': 'https://images.pexels.com/photos/2901215/pexels-photo-2901215.jpeg?auto=compress&w=800',
    };
    
    this.hotelImages = [
      'https://images.pexels.com/photos/271624/pexels-photo-271624.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/164595/pexels-photo-164595.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/271639/pexels-photo-271639.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/338504/pexels-photo-338504.jpeg?auto=compress&w=800',
      'https://images.pexels.com/photos/262048/pexels-photo-262048.jpeg?auto=compress&w=800',
    ];
  }

  // æœç´¢å›¾ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ Pexels APIï¼‰
  async searchImage(keyword, type = 'city') {
    console.log(`ğŸ” æœç´¢å›¾ç‰‡: ${keyword} (ç±»å‹: ${type})`);
    // ä¼˜å…ˆä½¿ç”¨ Unsplash APIï¼ˆå¦‚æœå·²é…ç½®ï¼‰
    if (this.useUnsplash) {
      try {
        const unsplashResult = await this.searchUnsplash(keyword);
        if (unsplashResult) {
          console.log(`âœ… Unsplashæœç´¢æˆåŠŸ`);
          return unsplashResult;
        }
      } catch (error) {
        console.log(`âš ï¸ Unsplashæœç´¢å¤±è´¥: ${error.message}`);
      }
    }
    // å…¶æ¬¡ä½¿ç”¨ Pexels APIï¼ˆå¦‚æœå·²é…ç½®ï¼‰
    if (this.usePexels) {
      try {
        let searchQuery;
        if (type === 'hotel') {
          searchQuery = keyword;
        } else {
          searchQuery = keyword;
        }
        console.log(`ğŸ” ä½¿ç”¨Pexelsæœç´¢: "${searchQuery}"`);
        const pexelsResult = await this.searchPexels(searchQuery);
        if (pexelsResult) {
          console.log(`âœ… Pexelsæœç´¢æˆåŠŸ`);
          return pexelsResult;
        }
  // Unsplash API æœç´¢
  async searchUnsplash(keyword) {
    if (!this.unsplashAccessKey || this.unsplashAccessKey === 'your_unsplash_access_key_here') {
      console.log('âš ï¸ Unsplash Access Key æœªé…ç½®æˆ–æ— æ•ˆ');
      return null;
    }
    try {
      const response = await axios.get('https://api.unsplash.com/search/photos', {
        params: {
          query: keyword,
          per_page: 1,
          orientation: 'landscape'
        },
        headers: {
          'Authorization': `Client-ID ${this.unsplashAccessKey}`
        },
        httpsAgent: this.httpsAgent,
        timeout: 12000,
        validateStatus: (status) => status === 200
      });
      if (response.data && response.data.results && response.data.results.length > 0) {
        const img = response.data.results[0].urls.regular;
        return img;
      }
      return null;
    } catch (error) {
      console.log('âŒ Unsplash API é”™è¯¯:', error.message);
      return null;
    }
  }
        
        // å¦‚æœä¸­æ–‡æœç´¢æ²¡æœ‰ç»“æœï¼Œå°è¯•è‹±æ–‡é™çº§
        console.log(`âš ï¸ ä¸­æ–‡æœç´¢æ— ç»“æœï¼Œå°è¯•è‹±æ–‡...`);
        
        if (type === 'hotel') {
          // é…’åº—é™çº§ç­–ç•¥ï¼šå°è¯•å¤šä¸ªè‹±æ–‡å…³é”®è¯
          const hotelQueries = [
            'luxury hotel lobby',
            'hotel room interior', 
            'five star hotel'
          ];
          
          for (const query of hotelQueries) {
            console.log(`ğŸ” å°è¯•è‹±æ–‡æœç´¢: "${query}"`);
            const result = await this.searchPexels(query);
            if (result) {
              console.log(`âœ… è‹±æ–‡æœç´¢æˆåŠŸ`);
              return result;
            }
          }
        } else {
          // åŸå¸‚é™çº§ï¼šä½¿ç”¨è‹±æ–‡åŸå¸‚å + ç‰¹å®šåœ°æ ‡
          const cityNameMap = {
            'åŒ—äº¬': 'beijing tiananmen square',
            'ä¸Šæµ·': 'shanghai oriental pearl tower', 
            'æ­å·': 'hangzhou west lake pagoda',
            'å¹¿å·': 'guangzhou canton tower night',
            'æ·±åœ³': 'shenzhen ping an tower',
            'æˆéƒ½': 'chengdu giant panda',
            'è¥¿å®‰': 'xian bell tower ancient',
            'å—äº¬': 'nanjing confucius temple',
            'é‡åº†': 'chongqing hongya cave',
            'å¤©æ´¥': 'tianjin eye ferris wheel',
            'è‹å·': 'suzhou classical garden',
            'æ­¦æ±‰': 'wuhan yellow crane tower',
            'é•¿æ²™': 'changsha orange island',
            'æµå—': 'jinan daming lake',
            'å“ˆå°”æ»¨': 'harbin saint sophia cathedral',
            'é’å²›': 'qingdao zhan bridge seaside',
            'å¦é—¨': 'xiamen gulangyu island',
            'å¤§è¿': 'dalian xinghai square',
            'æ²ˆé˜³': 'shenyang imperial palace',
            'æ˜†æ˜': 'kunming dianchi lake',
            'æ¡‚æ—': 'guilin lijiang river landscape',
            'ä¸‰äºš': 'sanya tianya haijiao beach',
            'æ‹‰è¨': 'lhasa potala palace'
          };
          
          const englishQuery = cityNameMap[keyword] || `${keyword.toLowerCase()} city landmark`;
          
          console.log(`ğŸ” ä½¿ç”¨è‹±æ–‡æœç´¢: "${englishQuery}"`);
          const englishResult = await this.searchPexels(englishQuery);
          
          if (englishResult) {
            console.log(`âœ… è‹±æ–‡æœç´¢æˆåŠŸ`);
            return englishResult;
          }
        }
        
      } catch (error) {
        console.log(`âš ï¸ Pexelsæœç´¢å¤±è´¥: ${error.message}ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ`);
      }
    }
    
    // å¦‚æœæ˜¯é…’åº—ç±»å‹ï¼Œä½¿ç”¨é¢„è®¾å›¾ç‰‡
    if (type === 'hotel') {
      const randomIndex = Math.floor(Math.random() * this.hotelImages.length);
      const imageUrl = this.hotelImages[randomIndex];
      console.log(`âœ… ä½¿ç”¨é¢„è®¾é…’åº—å›¾ç‰‡`);
      return imageUrl;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¾çš„åŸå¸‚å›¾ç‰‡
    const cityImage = this.getCityImage(keyword);
    if (cityImage) {
      console.log(`âœ… ä½¿ç”¨é¢„è®¾åŸå¸‚å›¾ç‰‡`);
      return cityImage;
    }
    
    // è¿”å›é€šç”¨åŸå¸‚å›¾ç‰‡
    console.log(`âš ï¸ ä½¿ç”¨é€šç”¨åŸå¸‚å›¾ç‰‡`);
    return 'https://images.pexels.com/photos/466685/pexels-photo-466685.jpeg?auto=compress&w=800';
  }
  
  // Pexels API æœç´¢ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
  async searchPexels(keyword, retries = 2) {
    // éªŒè¯ API Key æ ¼å¼
    if (!this.pexelsApiKey || this.pexelsApiKey === 'YOUR_PEXELS_API_KEY_HERE') {
      console.log(`âš ï¸ Pexels API Key æœªé…ç½®æˆ–æ— æ•ˆ`);
      return null;
    }
    
    for (let i = 0; i < retries; i++) {
      try {
        console.log(`ğŸ”„ Pexelsæœç´¢å°è¯• ${i + 1}/${retries}: "${keyword}"`);
        const startTime = Date.now();
        
        // æ£€æµ‹æ˜¯å¦ä¸ºä¸­æ–‡æŸ¥è¯¢
        const isChinese = /[\u4e00-\u9fa5]/.test(keyword);
        
        const response = await axios.get('https://api.pexels.com/v1/search', {
          params: {
            query: keyword,
            per_page: 1,
            orientation: 'landscape',
            locale: isChinese ? 'zh-CN' : 'en-US' // æ ¹æ®å…³é”®è¯è¯­è¨€è‡ªåŠ¨é€‰æ‹©
          },
          headers: {
            'Authorization': this.pexelsApiKey // æ–‡æ¡£è¦æ±‚ç›´æ¥ä¼ é€’ API Key
          },
          httpsAgent: this.httpsAgent, // ä½¿ç”¨æŒä¹…è¿æ¥
          timeout: 12000, // é¦–æ¬¡è¯·æ±‚éœ€è¦æ›´é•¿æ—¶é—´ï¼ˆDNS + TCP + TLS + HTTPï¼‰
          validateStatus: (status) => status === 200 // åªæ¥å—200çŠ¶æ€
        });
        
        const duration = Date.now() - startTime;
        console.log(`ğŸ“Š Pexelså“åº”æˆåŠŸ: ${duration}ms, ç»“æœæ•°: ${response.data.total_results}`);
        
        if (response.data.photos && response.data.photos.length > 0) {
          // ä½¿ç”¨ large å°ºå¯¸ï¼ˆæ–‡æ¡£å»ºè®®ï¼‰
          const imageUrl = response.data.photos[0].src.large || response.data.photos[0].src.original;
          console.log(`âœ… æ‰¾åˆ°å›¾ç‰‡: ${imageUrl.substring(0, 60)}...`);
          return imageUrl;
        }
        
        console.log(`âš ï¸ æœç´¢ "${keyword}" æ— ç»“æœ`);
        // å¦‚æœæ²¡æœ‰ç»“æœï¼Œä¸é‡è¯•
        return null;
        
      } catch (error) {
        const duration = Date.now() - startTime;
        const errorMsg = error.response?.status 
          ? `HTTP ${error.response.status}: ${error.response.statusText}` 
          : error.message;
        console.log(`âŒ ç¬¬ ${i + 1} æ¬¡å°è¯•å¤±è´¥ (${duration}ms): ${errorMsg}`);
        
        // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œç«‹å³è¿”å›
        if (error.response?.status === 401 || error.response?.status === 403) {
          console.log(`ğŸš« API Key è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ PEXELS_API_KEY æ˜¯å¦æ­£ç¡®`);
          return null;
        }
        
        // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œè¿”å›nullè€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
        if (i === retries - 1) {
          console.log(`ğŸ”´ æ‰€æœ‰é‡è¯•å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢„è®¾å›¾ç‰‡`);
          return null;
        }
        
        // ç­‰å¾…åé‡è¯•
        console.log(`â³ ç­‰å¾…1ç§’åé‡è¯•...`);
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
    return null;
  }

  // è·å–åŸå¸‚å›¾ç‰‡
  getCityImage(keyword) {
    // ç›´æ¥åŒ¹é…
    if (this.cityImageMap[keyword]) {
      return this.cityImageMap[keyword];
    }
    
    // æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«åŸå¸‚åï¼‰
    for (const [city, imageUrl] of Object.entries(this.cityImageMap)) {
      if (keyword.includes(city) || city.includes(keyword.split(' ')[0])) {
        return imageUrl;
      }
    }
    
    return null;
  }
}

// æ™ºè°±æ¸…è¨€ API æœåŠ¡
class ZhipuAIService {
  constructor() {
    this.apiKey = process.env.ZHIPU_API_KEY;
    this.apiUrl = process.env.ZHIPU_API_URL || 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
  }

  async generateTrip(params) {
    const { destination, date, days, type } = params;

    const typeNames = {
      family: 'å®¶åº­æ—…è¡Œ',
      couple: 'æƒ…ä¾£æ—…è¡Œ',
      solo: 'ç‹¬è‡ªæ—…è¡Œ',
      adventure: 'å†’é™©æ¢ç´¢'
    };

    const prompt = `è¯·ä¸ºæˆ‘è§„åˆ’ä¸€æ¬¡${days}å¤©çš„${destination}${typeNames[type] || 'æ—…è¡Œ'}ï¼Œå‡ºå‘æ—¥æœŸæ˜¯${date}ã€‚

âš ï¸ é‡è¦è¦æ±‚ï¼š
1. å¿…é¡»ç”Ÿæˆå®Œæ•´çš„${days}å¤©è¡Œç¨‹
2. æ¯å¤©åŒ…å«ä¸Šåˆã€ä¸­åˆã€ä¸‹åˆã€å‚æ™šçš„æ´»åŠ¨ï¼ˆæ¯å¤©è‡³å°‘4ä¸ªæ´»åŠ¨ï¼‰
3. ã€å…³é”®ã€‘åªè¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—
4. å›¾ç‰‡å­—æ®µæš‚æ—¶ç•™ç©ºï¼ˆå¡«å†™ "PLACEHOLDER"ï¼‰ï¼Œåç«¯ä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºçœŸå®å›¾ç‰‡

JSONæ ¼å¼ï¼š
{
  "title": "è¡Œç¨‹æ ‡é¢˜",
  "summary": {
    "days": ${days},
    "destinations": 1,
    "travelers": 4
  },
  "destinations": [
    {
      "id": 1,
      "city": "${destination}",
      "country": "ä¸­å›½",
      "description": "åŸå¸‚ç®€ä»‹",
      "landmark": "åŸå¸‚æœ€è‘—ååœ°æ ‡åç§°ï¼ˆç”¨äºæœç´¢å›¾ç‰‡ï¼Œä¾‹å¦‚ï¼šå¤©å®‰é—¨ã€ä¸œæ–¹æ˜ç ã€è¥¿æ¹–ç­‰ï¼‰",
      "image": "PLACEHOLDER",
      "days": [
        {
          "date": "æ—¥æœŸ",
          "title": "å½“å¤©ä¸»é¢˜",
          "activities": [
            {
              "time": "ä¸Šåˆ",
              "name": "æ´»åŠ¨åç§°",
              "description": "æ´»åŠ¨æè¿°",
              "icon": "ğŸ›ï¸",
              "duration": "2å°æ—¶"
            }
          ],
          "accommodation": "ä½å®¿åç§°"
        }
      ]
    }
  ],
  "hotels": [
    {
      "name": "é…’åº—åç§°",
      "city": "${destination}",
      "image": "PLACEHOLDER",
      "description": "é…’åº—æè¿°"
    }
  ]
}`;

    try {
      const response = await axios.post(
        this.apiUrl,
        {
          model: 'glm-4',
          messages: [
            {
              role: 'system',
              content: 'ä½ æ˜¯ä¸“ä¸šçš„æ—…è¡Œè§„åˆ’åŠ©æ‰‹ã€‚åªè¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼æ•°æ®ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ã€‚'
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 0.7,
          max_tokens: 4096
        },
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json'
          }
        }
      );

      const content = response.data.choices[0].message.content;
      console.log('ğŸ¤– æ™ºè°±AIåŸå§‹å“åº”:', content.substring(0, 200));
      
      return this.parseResponse(content);
    } catch (error) {
      console.error('âŒ æ™ºè°±AIè°ƒç”¨å¤±è´¥:', error.response?.data || error.message);
      throw error;
    }
  }

  parseResponse(content) {
    try {
      // æå– JSON
      let jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
      if (!jsonMatch) {
        jsonMatch = content.match(/```\s*([\s\S]*?)\s*```/);
      }
      
      let jsonStr = jsonMatch ? jsonMatch[1] : content;
      
      const firstBrace = jsonStr.indexOf('{');
      const lastBrace = jsonStr.lastIndexOf('}');
      
      if (firstBrace !== -1 && lastBrace !== -1) {
        jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
      }
      
      return JSON.parse(jsonStr.trim());
    } catch (error) {
      console.error('âŒ JSONè§£æå¤±è´¥:', error);
      throw new Error('æ— æ³•è§£æAIå“åº”');
    }
  }
}

// åˆå§‹åŒ–æœåŠ¡
const imageSearchService = new ImageSearchService();
const zhipuService = new ZhipuAIService();

// è¾…åŠ©å‡½æ•°ï¼šæå–é…’åº—å“ç‰Œå
function extractHotelBrand(hotelName) {
  // å¸¸è§é…’åº—å“ç‰Œåˆ—è¡¨
  const brands = [
    'å¸Œå°”é¡¿', 'ä¸‡è±ª', 'å–œæ¥ç™»', 'å‡¯æ‚¦', 'é¦™æ ¼é‡Œæ‹‰', 'æ´²é™…', 'çš‡å† å‡æ—¥',
    'å¨æ–¯æ±€', 'ä¸‡ä¸½', 'ç´¢è²ç‰¹', 'é“‚å°”æ›¼', 'è¯ºå¯Œç‰¹', 'ç¾å±…',
    'ä¸½æ€å¡å°”é¡¿', 'ç‘å‰', 'å®æ ¼ä¸½', 'å®‰ç¼¦', 'æ‚¦æ¦•åº„', 'æ–‡åä¸œæ–¹',
    'å››å­£', 'åŠå²›', 'åº·è±å¾·', 'åå°”é“å¤«', 'æŸæ‚¦', 'è‰¾è¿ªé€Š',
    'å‡¯å®¾æ–¯åŸº', 'è´¹å°”è’™', 'æœ—å»·', 'ä¸½æ™¶', 'ç’ä¸½', 'JWä¸‡è±ª',
    'Hilton', 'Marriott', 'Sheraton', 'Hyatt', 'InterContinental',
    'Westin', 'Sofitel', 'Ritz-Carlton', 'Four Seasons'
  ];
  
  // æŸ¥æ‰¾åŒ¹é…çš„å“ç‰Œ
  for (const brand of brands) {
    if (hotelName.includes(brand)) {
      return `${brand} é…’åº—`;
    }
  }
  
  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å“ç‰Œï¼Œè¿”å› nullï¼ˆä½¿ç”¨åŸå¸‚åé™çº§ï¼‰
  return null;
}

// API è·¯ç”±ï¼šç”Ÿæˆæ—…è¡Œè§„åˆ’
app.post('/api/generate-trip', async (req, res) => {
  try {
    const { destination, date, days, type } = req.body;
    
    console.log(`\nğŸ“ æ”¶åˆ°è¯·æ±‚: ${destination} ${days}å¤© ${type}`);
    
    // 1. è°ƒç”¨æ™ºè°±AIç”Ÿæˆè¡Œç¨‹
    console.log('ğŸ¤– æ­£åœ¨è°ƒç”¨æ™ºè°±AI...');
    const tripData = await zhipuService.generateTrip({ destination, date, days, type });
    
    // 2. æ›¿æ¢å›¾ç‰‡é“¾æ¥
    console.log('ğŸ–¼ï¸  æ­£åœ¨è·å–çœŸå®å›¾ç‰‡...');
    
    // æ›¿æ¢åŸå¸‚å›¾ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨LLMè¿”å›çš„åœ°æ ‡åç§°ï¼‰
    if (tripData.destinations && tripData.destinations[0]) {
      const destination = tripData.destinations[0];
      const cityName = destination.city;
      const landmark = destination.landmark; // LLMè¿”å›çš„åœ°æ ‡åç§°
      
      // åœ°æ ‡ä¸­è‹±æ–‡æ˜ å°„ï¼ˆç”¨äºPexelsè‹±æ–‡æœç´¢ï¼‰
      const landmarkEnglishMap = {
        'å¤©å®‰é—¨': 'tiananmen square',
        'æ•…å®«': 'forbidden city beijing',
        'é•¿åŸ': 'great wall china',
        'å¤©å›': 'temple of heaven',
        'é¢å’Œå›­': 'summer palace beijing',
        'ä¸œæ–¹æ˜ç ': 'oriental pearl tower',
        'å¤–æ»©': 'the bund shanghai',
        'è¥¿æ¹–': 'west lake hangzhou',
        'é›·å³°å¡”': 'leifeng pagoda',
        'å°è›®è…°': 'canton tower guangzhou',
        'å¹¿å·å¡”': 'canton tower night',
        'å¤©æ´¥ä¹‹çœ¼': 'tianjin eye ferris wheel',
        'ç´¢è²äºšæ•™å ‚': 'saint sophia cathedral harbin',
        'ä¸­å¤®å¤§è¡—': 'zhongyang street harbin',
        'å¤ªé˜³å²›': 'sun island harbin',
        'å†°é›ªå¤§ä¸–ç•Œ': 'harbin ice festival',
        'å¤§æ˜æ¹–': 'daming lake jinan',
        'è¶µçªæ³‰': 'baotu spring jinan',
        'åƒä½›å±±': 'qianfo mountain',
        'é»„é¹¤æ¥¼': 'yellow crane tower',
        'é’Ÿæ¥¼': 'bell tower xian',
        'å¤§é›å¡”': 'giant wild goose pagoda',
        'å…µé©¬ä¿‘': 'terracotta warriors',
        'æ´ªå´–æ´': 'hongya cave chongqing',
        'æœå¤©é—¨': 'chaotianmen chongqing',
        'é¼“æµªå±¿': 'gulangyu island',
        'å¸ƒè¾¾æ‹‰å®«': 'potala palace lhasa'
      };
      
      let searchKeyword;
      if (landmark) {
        // ä¼˜å…ˆä½¿ç”¨è‹±æ–‡åœ°æ ‡å
        const englishLandmark = landmarkEnglishMap[landmark];
        if (englishLandmark) {
          searchKeyword = englishLandmark;
          console.log(`ğŸ” ä½¿ç”¨è‹±æ–‡åœ°æ ‡: ${landmark} â†’ ${englishLandmark}`);
        } else {
          // é™çº§ä¸ºä¸­æ–‡
          searchKeyword = `${cityName} ${landmark}`;
          console.log(`ğŸ” ä½¿ç”¨ä¸­æ–‡æœç´¢: ${searchKeyword}`);
        }
      } else {
        searchKeyword = cityName;
      }
      
      destination.image = await imageSearchService.searchImage(searchKeyword, 'city');
      console.log(`âœ… åŸå¸‚å›¾ç‰‡: ${cityName}`);
    }
    
    // æ›¿æ¢é…’åº—å›¾ç‰‡ï¼ˆä½¿ç”¨æ™ºèƒ½æœç´¢ç­–ç•¥ï¼‰
    if (tripData.hotels) {
      for (let i = 0; i < tripData.hotels.length; i++) {
        const hotel = tripData.hotels[i];
        // æå–é…’åº—å“ç‰Œåæˆ–ä½¿ç”¨åŸå¸‚å
        // ä¾‹å¦‚ï¼š"å¤©æ´¥ç‘å‰é‡‘èè¡—é…’åº—" â†’ "ç‘å‰ é…’åº—" æˆ– "å¤©æ´¥ è±ªåé…’åº—"
        const hotelBrand = extractHotelBrand(hotel.name);
        const searchQuery = hotelBrand || `${hotel.city} è±ªåé…’åº—`;
        
        hotel.image = await imageSearchService.searchImage(searchQuery, 'hotel');
        console.log(`âœ… é…’åº—å›¾ç‰‡ ${i + 1}: ${hotel.name} (æœç´¢: ${searchQuery})`);
      }
    }
    
    console.log('âœ… è¡Œç¨‹ç”ŸæˆæˆåŠŸï¼\n');
    res.json(tripData);
    
  } catch (error) {
    console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
    res.status(500).json({ 
      error: 'ç”Ÿæˆæ—…è¡Œè§„åˆ’å¤±è´¥', 
      message: error.message 
    });
  }
});

// PDF ç”Ÿæˆè·¯ç”±
app.post('/api/generate-pdf', async (req, res) => {
  try {
    const tripData = req.body;
    console.log(`\nğŸ“„ å¼€å§‹ç”ŸæˆPDF: ${tripData.title}`);
    console.log(`ç›®çš„åœ°æ•°é‡: ${tripData.destinations?.length || 0}`);
    console.log(`é…’åº—æ•°é‡: ${tripData.hotels?.length || 0}`);
    
    // ç”ŸæˆPDF Buffer
    const pdfBuffer = await PDFService.generatePDF(tripData);
    
    if (!pdfBuffer || pdfBuffer.length === 0) {
      throw new Error('ç”Ÿæˆçš„PDFæ–‡ä»¶ä¸ºç©º');
    }
    
    // è®¾ç½®å“åº”å¤´
    const filename = `${tripData.title || 'æ—…è¡Œè®¡åˆ’'}_${Date.now()}.pdf`;
    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`);
    res.setHeader('Content-Length', pdfBuffer.length);
    res.setHeader('Cache-Control', 'no-cache');
    
    // è¿”å›PDFæ–‡ä»¶
    res.end(pdfBuffer, 'binary');
    console.log(`âœ… PDFç”ŸæˆæˆåŠŸ: ${filename} (${pdfBuffer.length} bytes)\n`);
    
    
    
  } catch (error) {
    console.error('âŒ PDFç”Ÿæˆå¤±è´¥:', error);
    res.status(500).json({ 
      error: 'PDFç”Ÿæˆå¤±è´¥', 
      message: error.message 
    });
  }
});

// å¥åº·æ£€æŸ¥
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    message: 'æ—…è¡Œè§„åˆ’åç«¯æœåŠ¡è¿è¡Œä¸­',
    zhipuConfigured: !!process.env.ZHIPU_API_KEY,
    imageService: process.env.PEXELS_API_KEY ? 'Pexels APIï¼ˆå·²é…ç½®ï¼‰' : 'é¢„è®¾å›¾ç‰‡åº“ï¼ˆé«˜è´¨é‡ï¼‰'
  });
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, async () => {
  console.log(`\nğŸš€ æ—…è¡Œè§„åˆ’åç«¯æœåŠ¡å·²å¯åŠ¨`);
  console.log(`ğŸ“ åœ°å€: http://localhost:${PORT}`);
  console.log(`ğŸ¤– æ™ºè°±AI: ${process.env.ZHIPU_API_KEY ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`);
  console.log(`ğŸ–¼ï¸  å›¾ç‰‡æœåŠ¡: ${process.env.PEXELS_API_KEY ? 'âœ… Pexels API' : 'âœ… é¢„è®¾å›¾ç‰‡åº“ï¼ˆæ¨èï¼‰'}`);
  
  // é¢„çƒ­ Pexels API è¿æ¥ï¼ˆé¿å…é¦–æ¬¡è¯·æ±‚è¶…æ—¶ï¼‰
  if (process.env.PEXELS_API_KEY && process.env.PEXELS_API_KEY !== 'YOUR_PEXELS_API_KEY_HERE') {
    console.log(`\nğŸ”¥ æ­£åœ¨é¢„çƒ­ Pexels API è¿æ¥...`);
    try {
      const testResponse = await axios.get('https://api.pexels.com/v1/search', {
        params: { query: 'test', per_page: 1 },
        headers: { 'Authorization': process.env.PEXELS_API_KEY },
        httpsAgent: httpsAgent,
        timeout: 15000
      });
      console.log(`âœ… Pexels è¿æ¥é¢„çƒ­æˆåŠŸï¼åç»­è¯·æ±‚å°†æ›´å¿«ã€‚`);
      console.log(`   å‰©ä½™é…é¢: ${testResponse.headers['x-ratelimit-remaining']}/${testResponse.headers['x-ratelimit-limit']}`);
    } catch (error) {
      console.log(`âš ï¸ Pexels é¢„çƒ­å¤±è´¥: ${error.message}`);
      console.log(`   ä¸å½±å“ä½¿ç”¨ï¼Œå°†åœ¨é¦–æ¬¡è¯·æ±‚æ—¶å»ºç«‹è¿æ¥`);
    }
  }
  
  console.log(`\nç­‰å¾…å‰ç«¯è¯·æ±‚...\n`);
});
