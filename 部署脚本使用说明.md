# 🚀 部署脚本执行步骤

## 当前状态：正在下载部署脚本 ✅

等待下载完成后，执行以下命令：

```bash
# 1. 检查脚本是否下载成功
ls -lh deploy.sh

# 2. 查看脚本内容（可选，确认脚本正确）
cat deploy.sh | head -20

# 3. 赋予执行权限
chmod +x deploy.sh

# 4. 运行部署脚本
bash deploy.sh
```

---

## ⚠️ 如果下载失败

如果看到 "404: Not Found" 或下载超时，说明 GitHub 仓库中还没有这个脚本。

**解决方法：手动创建脚本**

```bash
# 1. 创建脚本文件
nano deploy.sh

# 2. 复制以下内容到编辑器中
```

然后把下面的完整脚本内容复制进去：

```bash
#!/bin/bash

# 🚀 腾讯云服务器一键部署脚本
set -e

echo "=========================================="
echo "🚀 开始部署旅游规划AI项目"
echo "=========================================="

# 1. 更新系统
echo ""
echo "📦 第1步：更新系统包..."
sudo apt update && sudo apt upgrade -y

# 2. 安装 Node.js 18
echo ""
echo "📦 第2步：安装 Node.js 18..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt install -y nodejs
    echo "✅ Node.js 安装成功：$(node -v)"
else
    echo "✅ Node.js 已安装：$(node -v)"
fi

# 3. 安装 PM2
echo ""
echo "📦 第3步：安装 PM2 进程管理器..."
if ! command -v pm2 &> /dev/null; then
    sudo npm install -g pm2
    echo "✅ PM2 安装成功"
else
    echo "✅ PM2 已安装"
fi

# 4. 安装 Nginx
echo ""
echo "📦 第4步：安装 Nginx..."
if ! command -v nginx &> /dev/null; then
    sudo apt install -y nginx
    echo "✅ Nginx 安装成功"
else
    echo "✅ Nginx 已安装"
fi

# 5. 安装 Git
echo ""
echo "📦 第5步：检查 Git..."
if ! command -v git &> /dev/null; then
    sudo apt install -y git
    echo "✅ Git 安装成功"
else
    echo "✅ Git 已安装"
fi

# 6. 克隆项目
echo ""
echo "📦 第6步：获取项目代码..."
cd ~
PROJECT_DIR="travel-planning-ai"

if [ -d "$PROJECT_DIR" ]; then
    echo "⚠️  项目已存在，正在更新..."
    cd $PROJECT_DIR
    git pull
else
    echo "📥 正在克隆项目..."
    git clone https://github.com/kongsheng/travel-planning-ai.git
    cd $PROJECT_DIR
fi

# 7. 配置后端环境变量
echo ""
echo "📦 第7步：配置后端环境变量..."
cd backend

if [ ! -f ".env" ]; then
    echo "⚠️  创建 .env 文件..."
    cat > .env << 'EOF'
# 智谱清言 API
ZHIPU_API_KEY=你的智谱API密钥
ZHIPU_API_URL=https://open.bigmodel.cn/api/paas/v4/chat/completions

# Pexels 图片 API（可选）
PEXELS_API_KEY=

# 服务器配置
PORT=3001
NODE_ENV=production
EOF
    echo "❗ 请编辑 ~/travel-planning-ai/backend/.env 文件，填入你的 API Key！"
    echo "   执行命令：nano ~/travel-planning-ai/backend/.env"
    read -p "按 Enter 继续..."
else
    echo "✅ .env 文件已存在"
fi

# 8. 安装后端依赖
echo ""
echo "📦 第8步：安装后端依赖..."
npm install --production

# 9. 启动后端服务
echo ""
echo "📦 第9步：启动后端服务..."
pm2 stop travel-backend 2>/dev/null || true
pm2 delete travel-backend 2>/dev/null || true
pm2 start server.js --name travel-backend
pm2 save
sudo pm2 startup systemd -u ubuntu --hp /home/ubuntu
echo "✅ 后端服务已启动"

# 10. 构建前端
echo ""
echo "📦 第10步：构建前端..."
cd ..

cat > .env.production << 'EOF'
VITE_BACKEND_URL=http://localhost:3001
EOF

npm install
npm run build

# 11. 部署前端到 Nginx
echo ""
echo "📦 第11步：部署前端到 Nginx..."
sudo rm -rf /var/www/html/*
sudo cp -r dist/* /var/www/html/
echo "✅ 前端文件已复制到 Nginx"

# 12. 配置 Nginx
echo ""
echo "📦 第12步：配置 Nginx..."
sudo tee /etc/nginx/sites-available/default > /dev/null << 'EOF'
server {
    listen 80;
    server_name _;

    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
EOF

sudo nginx -t

if [ $? -eq 0 ]; then
    sudo systemctl restart nginx
    echo "✅ Nginx 配置成功并已重启"
else
    echo "❌ Nginx 配置有误，请检查"
    exit 1
fi

# 13. 配置防火墙
echo ""
echo "📦 第13步：配置防火墙..."
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable
echo "✅ 防火墙配置完成"

# 14. 显示运行状态
echo ""
echo "=========================================="
echo "✅ 部署完成！"
echo "=========================================="
echo ""
echo "📊 服务状态："
pm2 status
echo ""
echo "🌐 访问地址："
echo "   http://$(curl -s ifconfig.me)"
echo ""
echo "📝 常用命令："
echo "   查看后端日志：pm2 logs travel-backend"
echo "   重启后端：pm2 restart travel-backend"
echo "   查看 Nginx 状态：sudo systemctl status nginx"
echo "   重启 Nginx：sudo systemctl restart nginx"
echo ""
echo "⚠️  重要提醒："
echo "   1. 记得修改 backend/.env 文件中的 API Key"
echo "   2. 执行命令：nano ~/travel-planning-ai/backend/.env"
echo ""
echo "🎉 开始使用你的旅游规划AI吧！"
echo "=========================================="
```

保存方法：
- 按 `Ctrl + O` 保存
- 按 `Enter` 确认
- 按 `Ctrl + X` 退出

然后执行：
```bash
chmod +x deploy.sh
bash deploy.sh
```

---

## 📝 脚本会自动做什么

1. ✅ 更新系统
2. ✅ 安装 Node.js 18
3. ✅ 安装 PM2
4. ✅ 安装 Nginx
5. ✅ 克隆你的 GitHub 项目
6. ✅ 创建环境变量文件（需要你填入 API Key）
7. ✅ 安装所有依赖
8. ✅ 启动后端服务
9. ✅ 构建前端
10. ✅ 配置 Nginx
11. ✅ 配置防火墙

---

## ⚠️ 中途需要你做的

脚本运行到第7步时，会提示你编辑 `.env` 文件：

```bash
nano ~/travel-planning-ai/backend/.env
```

找到这一行：
```
ZHIPU_API_KEY=你的智谱API密钥
```

改成你的真实 API Key：
```
ZHIPU_API_KEY=你的实际密钥
```

保存并退出，然后按 Enter 继续。

---

## 🎉 完成后

浏览器访问：http://49.235.101.226

测试生成行程！
